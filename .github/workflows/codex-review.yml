name: Codex Review Prep

on:
  pull_request:
    types: [opened, ready_for_review, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: codex-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# 1) Сборка/проверка — сначала
jobs:
  build-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
      - run: npm run build
        env:
          CI: "true"

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Bundle size summary
        run: |
          du -sh dist || true
          find dist -type f -maxdepth 2 | wc -l || true

# 2) Лейбл + пинг — строго ПОСЛЕ build-check (и после возможных внешних автокоммитов)
  label-and-ping:
    needs: build-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add review label
        if: ${{ !github.event.pull_request.draft && !github.event.pull_request.head.repo.fork }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: codex:review

      - name: Request reviewers (from pr-meta.json or repo var, excluding author)
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/github-script@v7
        env:
          CODEX_REVIEWERS: ${{ vars.CODEX_REVIEWERS }}
        with:
          script: |
            const fs = require('fs');
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.pull_request.number;
            const author = context.payload.pull_request.user.login.toLowerCase();

            let reviewers = [];
            try {
              const raw = fs.readFileSync('.github/pr-meta.json', 'utf8');
              const meta = JSON.parse(raw);
              if (Array.isArray(meta.reviewers)) {
                reviewers.push(...meta.reviewers.map(s => String(s).trim().replace(/^@+/, '')));
              }
            } catch (_) { /* meta optional */ }

            const fromVar = (process.env.CODEX_REVIEWERS || '')
              .split(',')
              .map(s => s.trim().replace(/^@+/, ''))
              .filter(Boolean);

            reviewers = [...new Set([...reviewers, ...fromVar])]
              .filter(r => r.toLowerCase() !== author);

            if (reviewers.length === 0) {
              core.info('No reviewers (or only author). Skipping requestReviewers.');
              return;
            }

            await github.rest.pulls.requestReviewers({ owner, repo, pull_number: number, reviewers });
            core.info(`Requested reviewers: ${reviewers.join(', ')}`);

      # Получаем АКТУАЛЬНЫЙ head SHA прямо перед пингом (если был автокоммит — увидим его)
      - name: Finalize latest head SHA (stabilized)
        id: head
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNum = context.payload.pull_request.number;

            async function getHead() {
              const { data } = await github.rest.pulls.get({ owner, repo, pull_number: prNum });
              return data.head.sha;
            }

            // короткий стабилизатор: 3 попытки с паузами
            const sleep = ms => new Promise(r => setTimeout(r, ms));
            let sha1 = await getHead();
            await sleep(3000);
            let sha2 = await getHead();
            if (sha1 !== sha2) {
              await sleep(3000);
              sha2 = await getHead();
            }
            core.setOutput('sha', sha2);

      - name: Ping Codex to review (new comment per push, after all)
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.pull_request.number;

            const sha = '${{ steps.head.outputs.sha }}'.slice(0, 12);
            const body = [
              `[[CODEX-REVIEW-PING]]@${sha}`,
              '@codex review',
              '',
              `PR: #${number} — "${context.payload.pull_request.title}"`,
              `Branch: ${context.payload.pull_request.head.ref}`,
              `Head: ${sha}`,
              "Use the repository CODEX.md + the PR's pinned brief for scope/criteria."
            ].join('\n');

            await github.rest.issues.createComment({ owner, repo, issue_number: number, body });
            core.info(`Created Codex ping for head ${sha}.`)
