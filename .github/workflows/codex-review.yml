name: Codex Review Prep

on:
  pull_request:
    types: [opened, ready_for_review, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: codex-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ──────────────────────────────────────────────────────────────────────────────
# JOB 1. Build/check (идёт раньше), чтобы пинг улетал уже по финальному состоянию
# ──────────────────────────────────────────────────────────────────────────────
jobs:
  build-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
      - run: npm run build
        env:
          CI: "true"

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Bundle size summary
        run: |
          du -sh dist || true
          find dist -type f -maxdepth 2 | wc -l || true

# ──────────────────────────────────────────────────────────────────────────────
# JOB 2. Labels + ping (строго после build-check)
# ──────────────────────────────────────────────────────────────────────────────
  label-and-ping:
    needs: build-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add review label
        if: ${{ !github.event.pull_request.draft && !github.event.pull_request.head.repo.fork }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: codex:review

      - name: Request reviewers (from pr-meta.json or repo var; skip author)
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/github-script@v7
        env:
          CODEX_REVIEWERS: ${{ vars.CODEX_REVIEWERS }}
        with:
          script: |
            const fs = require('fs');
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.pull_request.number;
            const author = context.payload.pull_request.user.login.toLowerCase();

            let reviewers = [];
            try {
              const raw = fs.readFileSync('.github/pr-meta.json', 'utf8');
              const meta = JSON.parse(raw);
              if (Array.isArray(meta.reviewers)) reviewers.push(...meta.reviewers);
            } catch (_) {}

            const fromVar = (process.env.CODEX_REVIEWERS || '')
              .split(',')
              .map(s => s.trim())
              .filter(Boolean);

            reviewers = [...new Set([...reviewers, ...fromVar])]
              .map(s => s.replace(/^@+/, '').toLowerCase())
              .filter(r => r && r !== author);

            if (reviewers.length === 0) {
              core.info('No non-author reviewers configured; skipping.');
            } else {
              await github.rest.pulls.requestReviewers({ owner, repo, pull_number: number, reviewers });
              core.info(`Requested reviewers: ${reviewers.join(', ')}`);
            }

      # Берём максимально свежий head SHA (короткий стабилизатор на случай пост-коммита)
      - name: Finalize latest head SHA (stabilized)
        id: head
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNum = context.payload.pull_request.number;
            const sleep = ms => new Promise(r => setTimeout(r, ms));

            async function getHead() {
              const { data } = await github.rest.pulls.get({ owner, repo, pull_number: prNum });
              return data.head.sha;
            }

            let a = await getHead();
            await sleep(3000);
            let b = await getHead();
            if (a !== b) {
              await sleep(3000);
              b = await getHead();
            }
            core.setOutput('sha', b);

      # ВАЖНО: этот шаг использует PAT и пишет комментарий от твоего имени.
      # Требуется секрет AUTO_PR_TOKEN с правами: Pull requests (read/write), Issues (read/write) на этот репозиторий.
      - name: Ping Codex to review (new comment, authored by user PAT)
        if: ${{ !github.event.pull_request.draft }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_PR_TOKEN }}  # НЕ GITHUB_TOKEN
          script: |
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.pull_request.number;
            const sha    = '${{ steps.head.outputs.sha }}'.slice(0, 12);

            const body = [
              `[[CODEX-REVIEW-PING]]@${sha}`,
              `@codex review`,
              ``,
              `PR: #${number} — "${context.payload.pull_request.title}"`,
              `Branch: ${context.payload.pull_request.head.ref}`,
              `Head: ${sha}`,
              `Use the repository CODEX.md + the PR's pinned brief for scope/criteria.`
            ].join('\n');

            await github.rest.issues.createComment({ owner, repo, issue_number: number, body });
            core.info(`Created Codex ping for head ${sha}.`);

      # ────────────────────────────────────────────────────────────────────────
      # [Опционально, на будущее — fallback для FORK PRs]
      #
      # Если когда-нибудь откроются PR из форков, секреты (включая AUTO_PR_TOKEN)
      # им недоступны. Тогда этот шаг с PAT даст 401. Чтобы не падать, можно
      # включить бот-fallback: тот же пинг, но от github-actions[bot] (GITHUB_TOKEN).
      #
      # Для включения: УБЕРИ решётки с блока ниже.
      #
      # - name: Ping Codex to review (bot fallback for forks)
      #   if: ${{ !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name != github.repository }}
      #   uses: actions/github-script@v7
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const owner  = context.repo.owner;
      #       const repo   = context.repo.repo;
      #       const number = context.payload.pull_request.number;
      #       const sha    = '${{ steps.head.outputs.sha }}'.slice(0, 12);
      #       const body = [
      #         `[[CODEX-REVIEW-PING]]@${sha}`,
      #         `@codex review`,
      #         ``,
      #         `PR: #${number} — "${context.payload.pull_request.title}"`,
      #         `Branch: ${context.payload.pull_request.head.ref}`,
      #         `Head: ${sha}`
      #       ].join('\n');
      #       await github.rest.issues.createComment({ owner, repo, issue_number: number, body });
      #       core.info(`Fork fallback ping posted for head ${sha}.`);
