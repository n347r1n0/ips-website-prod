# CODEX.md — IPS Website

## 0) Role & Scope

Режим: **Full Agent**. Рабочая среда: **PROD-only workspace** для агентов.

Ты работаешь **только** в этом репозитории (Vite React SPA), в папке `frontend/`.
Задача — точечные безопасные правки **без деградации визуала/UX**.

**Строго запрещено**
- Любые правки конфигов/сборки/CI/зависимостей/окружения:
  `package.json`, `vite.config.*`, `tailwind.config.*`, `postcss.config.*`,
  `index.html`, `.github/workflows/*`, `.env*`.
- Бэкенд/БД/миграции/Edge Functions/секреты.
- «Большие переписывания» и массовые переименования без плана отката.
- Комментирование «в тред» и резолв обсуждений в PR: **давай готовый текст в чат — я вставлю сам**.

Перед началом **прочитай**:
`docs/codex/TASK__git-preflight-action-postflight.md` (preflight → action → postflight, авто-PR).

---

## 1) Структура (значимое)

```
ips-website/
├── .github/
│   └─ workflows/ (auto-open-pr.yml, codex-review.yml, deploy-pages.yml)
├── docs/    
│   └─ codex/
│       ├── reports/   # отчёты (см. §6)
│       └─ TASK__git-preflight-action-postflight.md│  
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── features/
│   │   │   │   ├── Admin/
│   │   │   │   │   ├── AdminRoute.jsx
│   │   │   │   │   ├── BlindsStructureEditor.jsx
│   │   │   │   │   ├── BlindsStructurePreview.jsx
│   │   │   │   │   ├── BuyInSettingsEditor.jsx
│   │   │   │   │   ├── DeleteConfirmModal.jsx
│   │   │   │   │   ├── MockTimerModal.jsx
│   │   │   │   │   └── TournamentModal.jsx
│   │   │   │   ├── AtmosphereGallery/
│   │   │   │   │   └── AtmosphereGallery.jsx
│   │   │   │   ├── Auth/
│   │   │   │   │   ├── AuthModal.jsx
│   │   │   │   │   ├── TelegramLoginWidget.jsx
│   │   │   │   │   └── TelegramLoginRedirect.jsx
│   │   │   │   ├── FAQ/
│   │   │   │   │   └── FAQ.jsx
│   │   │   │   ├── Hero/
│   │   │   │   │   └── HeroSection.jsx
│   │   │   │   ├── PlayerRatingWidget/
│   │   │   │   │   └── PlayerRatingWidget.jsx
│   │   │   │   ├── Profile/
│   │   │   │   │   └── AvatarField.jsx
│   │   │   │   ├── RegistrationForm/
│   │   │   │   │   ├── GuestFormModal.jsx
│   │   │   │   │   └── RegistrationForm.jsx
│   │   │   │   ├── TournamentCalendar/
│   │   │   │   │   ├── BlindsStructureViewer.jsx
│   │   │   │   │   ├── BuyInSummary.jsx
│   │   │   │   │   ├── EventMarker.jsx
│   │   │   │   │   ├── RegistrationConfirmationModal.jsx
│   │   │   │   │   ├── TournamentCalendar.jsx
│   │   │   │   │   ├── TournamentListForDay.jsx
│   │   │   │   │   ├── TournamentResultsModal.jsx
│   │   │   │   │   └── UpcomingTournamentsModal.jsx
│   │   │   │   ├── UserPaths/
│   │   │   │   │   └── UserPathsSection.jsx
│   │   │   │   └── ValueProps/
│   │   │   │       ├── FeatureCard.jsx
│   │   │   │       └── ValuePropsSection.jsx
│   │   │   ├── layout/ (Header, Footer, Section, etc.)
│   │   │   └── ui/ (AuthErrorDisplay, Button, GlassPanel, Toast, etc.)
│   │   ├── config/ (socialLinks.js)
│   │   ├── contexts/ (AuthContext.jsx)
│   │   ├── hooks/ (useAuthVersion.js, useMediaQuery.js, useSectionNav.js)
│   │   ├── lib/
│   │   │   ├── supabaseClient.js
│   │   │   ├── authSynchronizer.js
│   │   │   ├── sessionUtils.js
│   │   │   ├── sectionNav.js
│   │   │   ├── preAuthCleanup.js
│   │   │   ├── validatedStorage.js
│   │   │   ├── iosSafariUtils.js
│   │   │   └── …
│   │   ├── pages/ (HomePage, AdminDashboardPage, DashboardPage, TelegramCallbackPage)
│   │   ├── styles/ (buttons.css, helpers.css, legal.css, panels.css)
│   │   └─ ui/ (autogenerated font-files and FloatingChipWheel related files, tokens.css — imports once in index.css)
│   │   ├── App.jsx, main.jsx, index.css
│   ├── tailwind.config.js, postcss.config.js, vite.config.js
│   ├── AUTH-SYSTEM.md, CLAUDE.md, README.md
│   └── .env.local, .env.development.local
└── AGENTS.md
```

## 2) Дизайн-принципы (жёстко)

### 2.1 Token-first, без хардкода
- Цвета/тени/радиусы/блюр/прозрачности — **только токенами/переменными**.
- Если общего токена нет — вводи **локальную CSS-переменную с безопасным фолбэком**, например:
  `--gold: var(--gold, #D4AF37);` и используй `var(--gold)` в правилах.
- Геометрию/отступы, зависящие от высоты вьюпорта, задавай через `clamp()` и переменные с **vh-дефолтом + dvh-override**.
- Если вид компонента должен меняться из родителя — **прокинь проп** и на его основе выбирай классы/токены. Не размножай хардкод в глубине JSX/CSS.

### 2.2 Порядок импортов CSS (канон, не менять)

```css
/* index.css */
@import './ui/tokens.css';          /* всегда ПЕРВЫМ и один раз */

@import './styles/buttons.css';
@import './styles/panels.css';
@import './styles/helpers.css';
@import './styles/legal.css';

@tailwind base;
@tailwind components;
@tailwind utilities;                 /* всегда ПОСЛЕДНИМ */
````

### 2.3 Слои

* Все наши `styles/*.css` — **под `@layer`**:

  * обычно `@layer components { … }`, реже `@layer utilities { … }`.
* Любые `@media`-переопределения для тех же правил — **внутри того же `@layer`**, иначе не перекроют дефолт.

### 2.4 dvh/vh-фолбэки (паттерн)

```css
:root{
  --space-top: 6vh;   /* fallback для старых вебвью/браузеров */
}
@supports (height: 100dvh){
  :root{ --space-top: 6dvh; }  /* override для dvh-современных */
}
.block{ padding-top: var(--space-top); }
```

### 2.5 Якоря

* Используем **оба** отступа: `scroll-margin-top` **и** `scroll-margin-bottom`.
* Значения — через переменные с vh-дефолтом и dvh-override (см. 2.4).
* Для низких экранов (`@media (max-height:700px)`) — блок **в том же `@layer`**, чтобы переопределения реально сработали.

---

## 3) Код-конвенции

* Supabase импортируй **только** из `@/lib/supabaseClient` (единый инстанс).
* Перед auth-зависимыми запросами делай `await supabase.auth.getSession()`.
* Не меняй публичные пропсы/контракты без необходимости; новые ветки поведения — через флаг/проп с обратимой дорожкой (legacy — по умолчанию).
* Не вводи глобальные CSS-оверрайды, влияющие на чужие компоненты.

---

## 4) Процесс задачи

1. **Preflight** — прочитать `docs/codex/TASK__git-preflight-action-postflight.md` и следовать ему.
2. **Report-first** (в чат **и** файл, см. §6):

   * какие файлы и зачем;
   * что меняется визуально/поведенчески (1–2 предложения);
   * риски/откат;
   * чек-лист (5–8 пунктов).
3. **Patch** — небольшие обратимые правки.
4. **PR-note** — **только по запросу**: дай краткий текст в чат, я вставлю его в нужный тред сам.
5. **Postflight** — выполнить шаги из preflight-дока. Никаких самовольных действий в UI PR.

---

## 5) Guardrails

* Малые обратимые патчи > «больших переписок».
* Визуал PROD — эталон; изменения не ухудшают вид/ощущение.
* Не ломай порядок импортов; не выноси правила из `@layer`.
* Без правок конфигов/зависимостей/CI/Edge/БД.
* Никаких прямых хардкодов там, где можно решить токеном/переменной/пропом.

---

## 6) Отчёты

К каждой задаче/крупной подзадаче положи файл в:
`docs/codex/reports/`

**Имя:** `YYYYMMDD_HHMM__short-slug.md` (локальное время).

**Шаблон:**

```md
# <Short Title>

**When:** 2025-11-04 13:42  
**Branch:** <branch-name>  
**Commit(s):** <sha | planned>

## Why
<почему правим>

## What changed
- file1 — что и зачем
- file2 — что и зачем

## Visual/Behavior
<1–2 предложения о видимых эффектах>

## Risks & Rollback
<риски и быстрый откат>

## Checklist
- [ ] пункт проверки 1
- [ ] пункт проверки 2
- …

```
---

## 7) Чек-листы (шпаргалка примеров. у нас могут быть и другие)

**Общее**

* [ ] Консоль без ошибок/варнингов.
* [ ] Нет нежелательных сдвигов/«подпрыгиваний» при скролле.
* [ ] Тени/радиусы/стекло выглядят как прежде (или лучше).

**Hero / главная**

* [ ] Нет зазора над фоновым видео.
* [ ] Положение стеклянной панели соответствует задаче (контролируется через margin-top `clamp(var(--…))`).
* [ ] Высота секции не менялась, если задача так велит.

**Якоря/навигация**

* [ ] `scroll-margin-top` и `scroll-margin-bottom` заданы, двигаются по dvh/vh.
* [ ] На низких экранах применяются «короткие» оффсеты (media внутри того же `@layer`).
* [ ] Заголовки секций не прячутся под фикс-хедером/нижними контролами.

**Админка / симулятор**

* [ ] `MockTimerModal`: список турниров грузится, симуляция даёт ожидаемые изменения статусов/результатов.
* [ ] `AdminDashboardPage`: обновление после симуляции видно без перезагрузки страницы.

---

## 8) Что отвечать в начале каждой задачи

* Подтверждаю, что прочитал `docs/codex/TASK__git-preflight-action-postflight.md`.
* Даю **короткий отчёт** (см. §4 п.2) и **PR-note** (если я просил) для вставки.
* Обещаю соблюдать: маленькие обратимые патчи; запрет на конфиги/CI/Edge/БД; token-first; строгий порядок импортов; `@layer`-дисциплина; dvh/vh-фолбэки; медиа-override в том же `@layer`.
* После пуша — положу отчёт в `docs/codex/reports/…`.

---

Если что-то в задаче требует выхода за эти правила, сначала зафиксируй это в отчёте и предложи безопасный план.
