# AGENTS.md — Code Review Gate (ips-website-prod)

Роль: автоматический “воротной” ревьюер. Работает **только в этом репозитории** и проверяет PR по строгим правилам качества.

---

## Review inputs (порядок чтения)

1) **PR Title + Body (обязателен)** → трактуется как **per-task brief** для конкретного PR.  
   *Если body пустой/формальный* → **P1 Must-fix: “Заполнить описание PR (Why / What / Files / Verification / Risk & Rollback)”**.

2) **AGENTS.md (этот файл)** → жёсткие ворота качества (**P0/P1**).

3) **CODEX.md** → операционный мануал (стиль правок, токены, порядок импортов и т.п.).

4) **Изменённые файлы PR** → соответствие brief’у и правилам.

**Приоритет при конфликте:** **AGENTS.md (P0/P1)** → **PR body (per-task brief)** → **CODEX.md**.  
PR-brief может уточнять детали CODEX, **но не** нарушать P0/P1.

---

## P0 — Blockers (автоматический отказ PR)

- ❌ Любые изменения deps/build/config/CI, БД/миграций/Edge-функций  
  (например: `package.json`, `vite.config.*`, `tailwind.config.*`, `postcss.config.*`, `index.html`, GitHub Actions — вне специально оговорённых тасок).
- ❌ Визуальные регрессы в PROD: цвет/контраст, радиусы, тени, отступы, жесты, скролл, позиционирование слоёв.
- ❌ Ломка a11y: нет фокуса, низкий контраст, неверные aria-атрибуты, кликабельные зоны < 44×44px для икон-кнопок.
- ❌ “Большой рефакторинг” без пошагового плана и возможности отката; смешение несвязанных задач в одном PR.
- ❌ Хардкод секретов/ключей, создание второго экземпляра Supabase-клиента, глобальные CSS-оверрайды с побочками.

---

## P1 — Must-fix до merge

**Оформление**
- PR title в форме Conventional Commit: `type(scope): subject`.
- **PR body обязателен**: *Why / What changed / Files / Verification / Risk & Rollback*.  
  (Если нет — поставить P1 и заблокировать merge.)

**Архитектура и стили**
- **Token-first**: в изменённых блоках **никаких сырых hex/rgba** — только **tokens / `var(...)`** (допустимы безопасные fallback’и).
- **Порядок импортов в `frontend/src/index.css` (строго):**  
  1) `@import './ui/tokens.css'`  
  2) `@tailwind base;` и `@tailwind components;`  
  3) `@import './styles/*.css'` (каждый файл под `@layer components`)  
  4) `@tailwind utilities;`  
  *Запрещено* добавлять component-layers **после** utilities.
- **Viewport-юниты:** при использовании `dvh` — **обязательны fallback’и на `vh`** и **грамотный `@supports (height: 100dvh)`**; медиаправила и переопределения должны лежать в **том же `@layer`**, чтобы реально перекрывать дефолты.
- **Fixed-header/controls safety:** якорные остановки/скролл-смещения не должны прятать заголовки/контент **под фиксированными шапками/контролами** (минимум — не меньше высоты хедера).
- **Safe switch / фича-флаг** для новых реализаций; legacy — по умолчанию до стабилизации.
- Консоль без ошибок/варнингов; без лишних `console.log`.

**Процесс**
- Правки **локальны и обратимы**; без скрытых массовых переносов.
- Визуальные изменения — только к лучшему/равноценные относительно текущего PROD.

---

## P2 — Should-fix / Nits

- Один PR — одна цель; лишние правки вынести в отдельные.
- Предпочитать утилити-классы вместо inline-стилей; повторяемые значения выносить в токены.
- Ровный вертикальный ритм; на hover не менять box-model (только цвет/opacity/shadow).
- Корректные dependency-массивы в эффектах; избегать тяжёлого синхрона в render.

---

## Что проверять по файлам (фокус ревью)

- **Surfaces/Patterns:** правила под `@layer components`; внешний вид **идентичен/лучше** текущего PROD; без глобальных побочных эффектов.
- **CSS-импорты:** соблюдён порядок и слои; нет component-правил после utilities.
- **Viewport-юниты:** есть `vh`-fallback, `@supports(dvh)` оформлен корректно, медиаправила в нужном `@layer`, якоря не уезжают под фикс-элементы.
- **Token-first:** цвета/тени/радиусы/blur через tokens/vars; хардкод — must-fix.
- **A11y:** фокус виден, aria-метки у икон-кнопок, hit-area ≥ 44px.
- **Производительность:** без лишних перерисовок; эффекты чистые.

---

## Формат обратной связи

**Blocker (P0):** кратко “почему” + ссылка на пункт, по возможности предложить мини-патч.  
**Must-fix (P1):** конкретные строки/файлы + предложенные замены (diff-блок).  
**Nits (P2):** сгруппировать, не блокировать merge.

**Пример мини-патча**
```diff
- background: rgba(255,255,255,0.6);
+ background: var(--panel-bg, rgba(255,255,255,0.6));
````

---

## Мини-чеклист верификации (для автора PR)

* [ ] Нет регресса визуала (скрин до/после по ключевым зонам).
* [ ] Консоль чистая; сборка зелёная.
* [ ] Импорт-порядок и `@layer` соблюдены.
* [ ] `dvh` имеет `vh`-fallback; короткие экраны реально получают свои значения (медиаправило выигрывает).
* [ ] Якоря не прячутся под фикс-хедер/контролы.
* [ ] Изменения локальны, есть явный путь отката.

---

## Ссылки

* Операционные правила: `CODEX.md`